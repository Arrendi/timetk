<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Forecasting Using a Time Series Signature with timekit • timekit</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">timekit</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li>
  <a href="../reference/index.html">Function Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/TK00_Time_Series_Coercion.html">Time series coercion</a>
    </li>
    <li>
      <a href="../articles/TK01_Working_With_Time_Series_Index.html">Time series index</a>
    </li>
    <li>
      <a href="../articles/TK02_Making_A_Future_Time_Series_Index.html">Creating future time series indices</a>
    </li>
    <li>
      <a href="../articles/TK03_Forecasting_Using_Time_Series_Signature.html">Forecasting with timekit</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/business-science/timekit">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Forecasting Using a Time Series Signature with timekit</h1>
                        <h4 class="author">Matt Dancho</h4>
            
            <h4 class="date">2017-07-12</h4>
          </div>

    
    
<div class="contents">
<blockquote>
<p>A collection of tools for working with time series in R</p>
</blockquote>
<p>The time series signature is a collection of useful features that describe the time series index of a time-based data set. It contains a wealth of features that can be used to forecast time series that contain patterns. In this vignette, the user will learn methods to implement machine learning to predict future outcomes in a time-based data set. The vignette example uses a well known time series dataset, the Bike Sharing Dataset, from the UCI Machine Learning Repository. The vignette follows an example where we’ll use <code>timekit</code> to build a basic Machine Learning model to predict future values using the time series signature. The objective is to build a model and predict the next six months of Bike Sharing daily counts.</p>
<div id="prerequisites" class="section level1">
<h1 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h1>
<p>Before we get started, load the following packages.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyquant)
<span class="kw">library</span>(timekit)
<span class="kw">library</span>(broom)</code></pre></div>
</div>
<div id="data" class="section level1">
<h1 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h1>
<p>We’ll be using the <a href="https://archive.ics.uci.edu/ml/datasets/bike+sharing+dataset">Bike Sharing Dataset</a> from the UCI Machine Learning Repository. Download the data and select the “day.csv” file which is aggregated to daily periodicity.</p>
<p><em>Source: Fanaee-T, Hadi, and Gama, Joao, ‘Event labeling combining ensemble detectors and background knowledge’, Progress in Artificial Intelligence (2013): pp. 1-15, Springer Berlin Heidelberg</em></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Read data</span>
bikes &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"day.csv"</span>)

<span class="co"># Select date and count</span>
bikes &lt;-<span class="st"> </span>bikes <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(dteday, cnt) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">rename</span>(<span class="dt">date =</span> dteday)</code></pre></div>
<p>A visualization will help understand how we plan to tackle the problem of forecasting the data. We’ll split the data into two regions: a training region and a testing region.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Visualize data and training/testing regions</span>
bikes <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> cnt)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_rect</span>(<span class="dt">xmin =</span> <span class="kw">as.numeric</span>(<span class="kw">ymd</span>(<span class="st">"2012-07-01"</span>)),
              <span class="dt">xmax =</span> <span class="kw">as.numeric</span>(<span class="kw">ymd</span>(<span class="st">"2013-01-01"</span>)),
              <span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> <span class="dv">10000</span>,
              <span class="dt">fill =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">4</span>]], <span class="dt">alpha =</span> <span class="fl">0.01</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="kw">ymd</span>(<span class="st">"2011-10-01"</span>), <span class="dt">y =</span> <span class="dv">7800</span>,
             <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">label =</span> <span class="st">"Train Region"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="kw">ymd</span>(<span class="st">"2012-10-01"</span>), <span class="dt">y =</span> <span class="dv">1550</span>,
             <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">label =</span> <span class="st">"Test Region"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Bikes Sharing Dataset: Daily Scale"</span>, <span class="dt">x =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>()</code></pre></div>
<p><img src="TK03_Forecasting_Using_Time_Series_Signature_files/figure-html/unnamed-chunk-4-1.png" width="95%" style="display: block; margin: auto;"></p>
<p>Split the data into train and test sets at “2012-07-01”.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Split into training and test sets</span>
train &lt;-<span class="st"> </span>bikes <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(date <span class="op">&lt;</span><span class="st"> </span><span class="kw">ymd</span>(<span class="st">"2012-07-01"</span>))

test &lt;-<span class="st"> </span>bikes <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">filter</span>(date <span class="op">&gt;=</span><span class="st"> </span><span class="kw">ymd</span>(<span class="st">"2012-07-01"</span>))</code></pre></div>
</div>
<div id="modeling" class="section level1">
<h1 class="hasAnchor">
<a href="#modeling" class="anchor"></a>Modeling</h1>
<p>Start with the training set, which has the “date” and “cnt” columns.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Training set</span>
train</code></pre></div>
<pre><code>## # A tibble: 547 x 2
##          date   cnt
##        &lt;date&gt; &lt;int&gt;
##  1 2011-01-01   985
##  2 2011-01-02   801
##  3 2011-01-03  1349
##  4 2011-01-04  1562
##  5 2011-01-05  1600
##  6 2011-01-06  1606
##  7 2011-01-07  1510
##  8 2011-01-08   959
##  9 2011-01-09   822
## 10 2011-01-10  1321
## # ... with 537 more rows</code></pre>
<p>The first step is to add the <em>time series signature</em> to the training set, which will be used this to learn the patterns. The most efficient method is using <code><a href="../reference/tk_augment_timeseries.html">tk_augment_timeseries_signature()</a></code>, which adds the columns we need as additional columns.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Add time series signature</span>
train_augmented &lt;-<span class="st"> </span>train <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/tk_augment_timeseries.html">tk_augment_timeseries_signature</a></span>()
train_augmented</code></pre></div>
<pre><code>## # A tibble: 547 x 30
##          date   cnt  index.num  diff  year year.iso  half quarter month
##        &lt;date&gt; &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt;
##  1 2011-01-01   985 1293840000    NA  2011     2010     1       1     1
##  2 2011-01-02   801 1293926400 86400  2011     2010     1       1     1
##  3 2011-01-03  1349 1294012800 86400  2011     2011     1       1     1
##  4 2011-01-04  1562 1294099200 86400  2011     2011     1       1     1
##  5 2011-01-05  1600 1294185600 86400  2011     2011     1       1     1
##  6 2011-01-06  1606 1294272000 86400  2011     2011     1       1     1
##  7 2011-01-07  1510 1294358400 86400  2011     2011     1       1     1
##  8 2011-01-08   959 1294444800 86400  2011     2011     1       1     1
##  9 2011-01-09   822 1294531200 86400  2011     2011     1       1     1
## 10 2011-01-10  1321 1294617600 86400  2011     2011     1       1     1
## # ... with 537 more rows, and 21 more variables: month.xts &lt;int&gt;,
## #   month.lbl &lt;ord&gt;, day &lt;int&gt;, hour &lt;int&gt;, minute &lt;int&gt;, second &lt;int&gt;,
## #   hour12 &lt;int&gt;, am.pm &lt;int&gt;, wday &lt;int&gt;, wday.xts &lt;int&gt;, wday.lbl &lt;ord&gt;,
## #   mday &lt;int&gt;, qday &lt;int&gt;, yday &lt;int&gt;, mweek &lt;int&gt;, week &lt;int&gt;,
## #   week.iso &lt;int&gt;, week2 &lt;int&gt;, week3 &lt;int&gt;, week4 &lt;int&gt;, mday7 &lt;int&gt;</code></pre>
<p>Now that we have a number of fields that can be used for training, we can use these for modeling. <em>In practice, you will want to go through the process of pre-processing the data, centering and scaling if necessary, making dummy variables, removing correlated variables that are present, examining interactions, etc. For brevity, we do not do this here.</em></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Model using the augmented features</span>
fit_lm &lt;-<span class="st"> </span><span class="kw">lm</span>(cnt <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> train_augmented)</code></pre></div>
<p>We can examine the model residuals to see if there is any significant pattern remaining using <code><a href="http://www.rdocumentation.org/packages/broom/topics/augment">augment()</a></code> from the <code>broom</code> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Visualize the residuals of training set</span>
fit_lm <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/broom/topics/augment">augment</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> .resid)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">"red"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Training Set: lm() Model Residuals"</span>, <span class="dt">x =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">5000</span>, <span class="dv">5000</span>))</code></pre></div>
<p><img src="TK03_Forecasting_Using_Time_Series_Signature_files/figure-html/unnamed-chunk-9-1.png" width="95%" style="display: block; margin: auto;"></p>
<p>We can also get a quick idea of the overall error of the model on the training set. Note that what we really care about is the error on the test set, as this is a much better predictor of future model performance.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># RMSE</span>
<span class="kw">sqrt</span>(<span class="kw">mean</span>(fit_lm<span class="op">$</span>residuals<span class="op">^</span><span class="dv">2</span>))</code></pre></div>
<pre><code>## [1] 860.2119</code></pre>
</div>
<div id="test-validation" class="section level1">
<h1 class="hasAnchor">
<a href="#test-validation" class="anchor"></a>Test Validation</h1>
<p>With a suitable model (low residual error and random residuals) we can forecast using the “test” set for validation purposes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test</code></pre></div>
<pre><code>## # A tibble: 184 x 2
##          date   cnt
##        &lt;date&gt; &lt;int&gt;
##  1 2012-07-01  5531
##  2 2012-07-02  6227
##  3 2012-07-03  6660
##  4 2012-07-04  7403
##  5 2012-07-05  6241
##  6 2012-07-06  6207
##  7 2012-07-07  4840
##  8 2012-07-08  4672
##  9 2012-07-09  6569
## 10 2012-07-10  6290
## # ... with 174 more rows</code></pre>
<p>We need to again augment the time series signature to the test set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">test_augmented &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/tk_augment_timeseries.html">tk_augment_timeseries_signature</a></span>()
test_augmented</code></pre></div>
<pre><code>## # A tibble: 184 x 30
##          date   cnt  index.num  diff  year year.iso  half quarter month
##        &lt;date&gt; &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt; &lt;int&gt;   &lt;int&gt; &lt;int&gt;
##  1 2012-07-01  5531 1341100800    NA  2012     2012     2       3     7
##  2 2012-07-02  6227 1341187200 86400  2012     2012     2       3     7
##  3 2012-07-03  6660 1341273600 86400  2012     2012     2       3     7
##  4 2012-07-04  7403 1341360000 86400  2012     2012     2       3     7
##  5 2012-07-05  6241 1341446400 86400  2012     2012     2       3     7
##  6 2012-07-06  6207 1341532800 86400  2012     2012     2       3     7
##  7 2012-07-07  4840 1341619200 86400  2012     2012     2       3     7
##  8 2012-07-08  4672 1341705600 86400  2012     2012     2       3     7
##  9 2012-07-09  6569 1341792000 86400  2012     2012     2       3     7
## 10 2012-07-10  6290 1341878400 86400  2012     2012     2       3     7
## # ... with 174 more rows, and 21 more variables: month.xts &lt;int&gt;,
## #   month.lbl &lt;ord&gt;, day &lt;int&gt;, hour &lt;int&gt;, minute &lt;int&gt;, second &lt;int&gt;,
## #   hour12 &lt;int&gt;, am.pm &lt;int&gt;, wday &lt;int&gt;, wday.xts &lt;int&gt;, wday.lbl &lt;ord&gt;,
## #   mday &lt;int&gt;, qday &lt;int&gt;, yday &lt;int&gt;, mweek &lt;int&gt;, week &lt;int&gt;,
## #   week.iso &lt;int&gt;, week2 &lt;int&gt;, week3 &lt;int&gt;, week4 &lt;int&gt;, mday7 &lt;int&gt;</code></pre>
<p>Next, use <code>predict()</code> to apply the model to the test set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">yhat_test &lt;-<span class="st"> </span><span class="kw">predict</span>(fit_lm, <span class="dt">newdata =</span> test_augmented)</code></pre></div>
<p>Add the predictions (use <code>add_column</code> for numeric vectors) to the test set for comparison. Additionally, we can add the residuals using <code>mutate()</code>, which enables performing calculations between columns of a data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred_test &lt;-<span class="st"> </span>test <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">add_column</span>(<span class="dt">yhat =</span> yhat_test) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">.resid =</span> cnt <span class="op">-</span><span class="st"> </span>yhat)
pred_test</code></pre></div>
<pre><code>## # A tibble: 184 x 4
##          date   cnt     yhat      .resid
##        &lt;date&gt; &lt;int&gt;    &lt;dbl&gt;       &lt;dbl&gt;
##  1 2012-07-01  5531 6264.223  -733.22284
##  2 2012-07-02  6227 6638.720  -411.72045
##  3 2012-07-03  6660 6846.848  -186.84846
##  4 2012-07-04  7403 6688.552   714.44821
##  5 2012-07-05  6241 6915.828  -674.82813
##  6 2012-07-06  6207 6937.066  -730.06598
##  7 2012-07-07  4840 6953.464 -2113.46428
##  8 2012-07-08  4672 6623.205 -1951.20517
##  9 2012-07-09  6569 6621.562   -52.56221
## 10 2012-07-10  6290 6829.690  -539.69023
## # ... with 174 more rows</code></pre>
<p>Visualize the results using <code>ggplot()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date), <span class="dt">data =</span> bikes) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_rect</span>(<span class="dt">xmin =</span> <span class="kw">as.numeric</span>(<span class="kw">ymd</span>(<span class="st">"2012-07-01"</span>)),
              <span class="dt">xmax =</span> <span class="kw">as.numeric</span>(<span class="kw">ymd</span>(<span class="st">"2013-01-01"</span>)),
              <span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> <span class="dv">10000</span>,
              <span class="dt">fill =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">4</span>]], <span class="dt">alpha =</span> <span class="fl">0.01</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="kw">ymd</span>(<span class="st">"2011-10-01"</span>), <span class="dt">y =</span> <span class="dv">7800</span>,
             <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">label =</span> <span class="st">"Train Region"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="kw">ymd</span>(<span class="st">"2012-10-01"</span>), <span class="dt">y =</span> <span class="dv">1550</span>,
             <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">label =</span> <span class="st">"Test Region"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> cnt), <span class="dt">data =</span> train, <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> cnt), <span class="dt">data =</span> pred_test, <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> yhat), <span class="dt">data =</span> pred_test, <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">2</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>() </code></pre></div>
<p><img src="TK03_Forecasting_Using_Time_Series_Signature_files/figure-html/unnamed-chunk-15-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="test-accuracy" class="section level1">
<h1 class="hasAnchor">
<a href="#test-accuracy" class="anchor"></a>Test Accuracy</h1>
<p>The <a href="https://www.otexts.org/fpp/2/5">forecast accuracy</a> can be evaluated on the test set using residual diagnostics and forecast accuracy measures.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculating forecast error</span>
test_residuals &lt;-<span class="st"> </span>pred_test<span class="op">$</span>.resid
pct_err &lt;-<span class="st"> </span>test_residuals<span class="op">/</span>pred_test<span class="op">$</span>cnt <span class="op">*</span><span class="st"> </span><span class="dv">100</span> <span class="co"># Percentage error</span>

me   &lt;-<span class="st"> </span><span class="kw">mean</span>(test_residuals, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
rmse &lt;-<span class="st"> </span><span class="kw">mean</span>(test_residuals<span class="op">^</span><span class="dv">2</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">^</span><span class="fl">0.5</span>
mae  &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">abs</span>(test_residuals), <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
mape &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">abs</span>(pct_err), <span class="dt">na.rm=</span><span class="ot">TRUE</span>)
mpe  &lt;-<span class="st"> </span><span class="kw">mean</span>(pct_err, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)

error_tbl &lt;-<span class="st"> </span><span class="kw">tibble</span>(me, rmse, mae, mape, mpe)
error_tbl</code></pre></div>
<pre><code>## # A tibble: 1 x 5
##          me     rmse      mae     mape      mpe
##       &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1 -46.53047 1440.099 1047.875 182.3272 -168.681</code></pre>
<p>Next we can visualize the residuals of the test set. The residuals of the model aren’t perfect, but we can work with it. The residuals show that the model predicts low in October and high in December.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> .resid), <span class="dt">data =</span> pred_test) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">color =</span> <span class="st">"red"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_smooth</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Test Set: lm() Model Residuals"</span>, <span class="dt">x =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">limits =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">5000</span>, <span class="dv">5000</span>))</code></pre></div>
<p><img src="TK03_Forecasting_Using_Time_Series_Signature_files/figure-html/unnamed-chunk-17-1.png" width="95%" style="display: block; margin: auto;"></p>
<p>At this point you might go back to the model and try tweaking features using interactions or polynomial terms, adding other features that may be known in the future (e.g. temperature of day can be forecasted relatively accurately within 7 days), or try a completely different modeling technique with the hope of better predictions on the test set. Once you feel that your model is optimized, move on the final step of forecasting.</p>
</div>
<div id="forecasting" class="section level1">
<h1 class="hasAnchor">
<a href="#forecasting" class="anchor"></a>Forecasting</h1>
<p>Let’s use our model to predict What are the expected future values for the next six months. The first step is to create the date sequence. Let’s use <code><a href="../reference/tk_get_timeseries.html">tk_get_timeseries_summary()</a></code> to review the summary of the dates from the original dataset, “bikes”.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Extract bikes index</span>
idx &lt;-<span class="st"> </span>bikes <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">tk_index</span>()

<span class="co"># Get time series summary from index</span>
bikes_summary &lt;-<span class="st"> </span>idx <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/tk_get_timeseries.html">tk_get_timeseries_summary</a></span>()</code></pre></div>
<p>The first six parameters are general summary information.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bikes_summary[<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]</code></pre></div>
<pre><code>## # A tibble: 1 x 6
##   n.obs      start        end units scale tzone
##   &lt;int&gt;     &lt;date&gt;     &lt;date&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
## 1   731 2011-01-01 2012-12-31  days   day   UTC</code></pre>
<p>The second six parameters are the periodicity information.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bikes_summary[<span class="dv">7</span><span class="op">:</span><span class="dv">12</span>]</code></pre></div>
<pre><code>## # A tibble: 1 x 6
##   diff.minimum diff.q1 diff.median diff.mean diff.q3 diff.maximum
##          &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;        &lt;dbl&gt;
## 1        86400   86400       86400     86400   86400        86400</code></pre>
<p>From the summary, we know that the data is 100% regular because the median and mean differences are 86400 seconds or 1 day. We don’t need to do any special inspections when we use <code><a href="../reference/tk_make_future_timeseries.html">tk_make_future_timeseries()</a></code>. If the data was irregular, meaning weekends or holidays were excluded, you’d want to account for this. Otherwise your forecast would be inaccurate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">idx_future &lt;-<span class="st"> </span>idx <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/tk_make_future_timeseries.html">tk_make_future_timeseries</a></span>(<span class="dt">n_future =</span> <span class="dv">180</span>)</code></pre></div>
<p>To make the prediction, we need to use the future index to get the time series signature (<code><a href="../reference/tk_get_timeseries.html">tk_get_timeseries_signature()</a></code>). Make sure to rename the column “index” to “date” so it matches the column names of the original data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_future &lt;-<span class="st"> </span>idx_future <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="../reference/tk_get_timeseries.html">tk_get_timeseries_signature</a></span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">rename</span>(<span class="dt">date =</span> index)</code></pre></div>
<p>Make the prediction.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pred_future &lt;-<span class="st"> </span><span class="kw">predict</span>(fit_lm, <span class="dt">newdata =</span> data_future)</code></pre></div>
<p>Build the future data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bikes_future &lt;-<span class="st"> </span>data_future <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(date) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">add_column</span>(<span class="dt">cnt =</span> pred_future)</code></pre></div>
<p>Visualize the forecast.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bikes <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> cnt)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_rect</span>(<span class="dt">xmin =</span> <span class="kw">as.numeric</span>(<span class="kw">ymd</span>(<span class="st">"2012-07-01"</span>)),
              <span class="dt">xmax =</span> <span class="kw">as.numeric</span>(<span class="kw">ymd</span>(<span class="st">"2013-01-01"</span>)),
              <span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> <span class="dv">10000</span>,
              <span class="dt">fill =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">4</span>]], <span class="dt">alpha =</span> <span class="fl">0.01</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_rect</span>(<span class="dt">xmin =</span> <span class="kw">as.numeric</span>(<span class="kw">ymd</span>(<span class="st">"2013-01-01"</span>)),
              <span class="dt">xmax =</span> <span class="kw">as.numeric</span>(<span class="kw">ymd</span>(<span class="st">"2013-07-01"</span>)),
              <span class="dt">ymin =</span> <span class="dv">0</span>, <span class="dt">ymax =</span> <span class="dv">10000</span>,
              <span class="dt">fill =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">3</span>]], <span class="dt">alpha =</span> <span class="fl">0.01</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="kw">ymd</span>(<span class="st">"2011-10-01"</span>), <span class="dt">y =</span> <span class="dv">7800</span>,
             <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">label =</span> <span class="st">"Train Region"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="kw">ymd</span>(<span class="st">"2012-10-01"</span>), <span class="dt">y =</span> <span class="dv">1550</span>,
             <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">label =</span> <span class="st">"Test Region"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="kw">ymd</span>(<span class="st">"2013-4-01"</span>), <span class="dt">y =</span> <span class="dv">1550</span>,
             <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]], <span class="dt">label =</span> <span class="st">"Forecast Region"</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> cnt), <span class="dt">data =</span> bikes_future,
               <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">2</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> cnt), <span class="dt">data =</span> bikes_future,
                <span class="dt">method =</span> <span class="st">'loess'</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Bikes Sharing Dataset: 6-Month Forecast"</span>, <span class="dt">x =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>()</code></pre></div>
<p><img src="TK03_Forecasting_Using_Time_Series_Signature_files/figure-html/unnamed-chunk-25-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="forecast-error" class="section level1">
<h1 class="hasAnchor">
<a href="#forecast-error" class="anchor"></a>Forecast Error</h1>
<p>A forecast is never perfect. We need prediction intervals to account for the variance from the model predictions to the actual data. There’s a number of methods to achieve this. We’ll follow the <a href="https://www.otexts.org/fpp/2/7">prediction interval</a> methodology from Forecasting: Principles and Practice.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Calculate standard deviation of residuals</span>
test_resid_sd &lt;-<span class="st"> </span><span class="kw">sd</span>(test_residuals)

bikes_future &lt;-<span class="st"> </span>bikes_future <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>(
        <span class="dt">lo.95 =</span> cnt <span class="op">-</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>test_resid_sd,
        <span class="dt">lo.80 =</span> cnt <span class="op">-</span><span class="st"> </span><span class="fl">1.28</span> <span class="op">*</span><span class="st"> </span>test_resid_sd,
        <span class="dt">hi.80 =</span> cnt <span class="op">+</span><span class="st"> </span><span class="fl">1.28</span> <span class="op">*</span><span class="st"> </span>test_resid_sd,
        <span class="dt">hi.95 =</span> cnt <span class="op">+</span><span class="st"> </span><span class="fl">1.96</span> <span class="op">*</span><span class="st"> </span>test_resid_sd
        )</code></pre></div>
<p>Now, plotting the forecast with the prediction intervals.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">bikes <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> cnt)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">1</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lo.<span class="dv">95</span>, <span class="dt">ymax =</span> hi.<span class="dv">95</span>), <span class="dt">data =</span> bikes_future, 
                <span class="dt">fill =</span> <span class="st">"#D5DBFF"</span>, <span class="dt">color =</span> <span class="ot">NA</span>, <span class="dt">size =</span> <span class="dv">0</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> lo.<span class="dv">80</span>, <span class="dt">ymax =</span> hi.<span class="dv">80</span>, <span class="dt">fill =</span> key), <span class="dt">data =</span> bikes_future,
                <span class="dt">fill =</span> <span class="st">"#596DD5"</span>, <span class="dt">color =</span> <span class="ot">NA</span>, <span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">alpha =</span> <span class="fl">0.8</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> cnt), <span class="dt">data =</span> bikes_future,
               <span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">color =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/palette_tq">palette_light</a></span>()[[<span class="dv">2</span>]]) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_smooth</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> cnt), <span class="dt">data =</span> bikes_future,
                <span class="dt">method =</span> <span class="st">'loess'</span>, <span class="dt">color =</span> <span class="st">"white"</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">"Bikes Sharing Dataset: 6-Month Forecast with Prediction Intervals"</span>, <span class="dt">x =</span> <span class="st">""</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyquant/topics/theme_tq">theme_tq</a></span>()</code></pre></div>
<p><img src="TK03_Forecasting_Using_Time_Series_Signature_files/figure-html/unnamed-chunk-27-1.png" width="95%" style="display: block; margin: auto;"></p>
</div>
<div id="parting-thoughts" class="section level1">
<h1 class="hasAnchor">
<a href="#parting-thoughts" class="anchor"></a>Parting Thoughts</h1>
<p>Forecasting using the time series signature can be very accurate especially when time-based patterns are present in the underlying data. As with most machine learning applications, the prediction is only as good as the patterns in the data. Forecasting using this approach may <em>not</em> be suitable when patterns are not present or when the future is highly uncertain (i.e. past is not a suitable predictor of future performance). However, in may situations the time series signature can provide an accurate forecast.</p>
<p>One benefit to the machine learning approach that was not covered in this vignette but is an significant advantage is that other features (including non-time-based) can be included in the analysis if the values are present in the training and test sets and can be determined with some level of accuracy in the future. For example, one can expect that experts in Bike Sharing analytics have access to historical temperature and weather patterns, wind speeds, and so on that could have a significant affect on bicycle sharing. The beauty of this method is these features can easily be incorporated into the model and prediction.</p>
<p>Last, a few points on the modeling process. Important modeling steps such as pre-processing data, removing correlated features, and so on where not addressed or included in this vignette. The astute modeler would certainly review the data and processing accordingly to achieve an optimal model.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#data">Data</a></li>
      <li><a href="#modeling">Modeling</a></li>
      <li><a href="#test-validation">Test Validation</a></li>
      <li><a href="#test-accuracy">Test Accuracy</a></li>
      <li><a href="#forecasting">Forecasting</a></li>
      <li><a href="#forecast-error">Forecast Error</a></li>
      <li><a href="#parting-thoughts">Parting Thoughts</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Matt Dancho, Davis Vaughan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
